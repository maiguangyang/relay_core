# 架构设计

## 整体架构

```
┌──────────────────────────────────────────────────────────────┐
│                       Flutter App                            │
│  ┌────────────────────────────────────────────────────────┐ │
│  │                    Dart 层                               │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │ │
│  │  │ LiveKit SDK │  │ 信令服务    │  │ UI / 业务逻辑   │ │ │
│  │  └──────┬──────┘  └──────┬──────┘  └────────────────┘  │ │
│  │         │                │                              │ │
│  │         ▼                ▼                              │ │
│  │  ┌─────────────────────────────────────────────────┐   │ │
│  │  │              Relay Bridge (Dart FFI)            │   │ │
│  │  └────────────────────┬────────────────────────────┘   │ │
│  └───────────────────────┼────────────────────────────────┘ │
│                          │                                   │
│  ┌───────────────────────▼────────────────────────────────┐ │
│  │                 Go Relay Core (C-Shared)                │ │
│  │  ┌───────────┐  ┌────────────┐  ┌───────────────────┐ │ │
│  │  │ RelayRoom │  │ SourceSwit │  │ Election/Keepalive│ │ │
│  │  │  (P2P)    │  │   cher     │  │   /Stats/Probe    │ │ │
│  │  └───────────┘  └────────────┘  └───────────────────┘ │ │
│  └───────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
```

## 核心模块

### 1. RelayRoom - P2P 连接管理

管理 Relay 节点与局域网订阅者之间的 WebRTC P2P 连接。

```
Relay 节点
    │
    ├─── P2P ──→ 订阅者 1 (手机)
    ├─── P2P ──→ 订阅者 2 (手机)
    └─── P2P ──→ 订阅者 3 (平板)
```

### 2. SourceSwitcher - 双源切换器

实现"代理模式"的核心，支持两路输入源无缝切换：

```
Input A (SFU 流)        Input B (本地分享)
       │                       │
       └───────┬───────────────┘
               ▼
        ┌─────────────┐
        │  Switcher   │  ← 自动切换
        └──────┬──────┘
               ▼
          所有订阅者
```

### 3. Election - 动态代理选举

根据设备评分自动选择最优 Relay 节点：

| 设备类型 | 基础分 | 连接类型乘数 | 电源状态乘数 |
|---------|-------|------------|------------|
| PC/Mac  | 100   | Ethernet ×1.0 | 充电中 ×1.0 |
| 智能电视 | 90    | WiFi ×0.8     | 电池 ×0.7   |
| 平板    | 60    | 蜂窝 ×0.3     | 低电量 ×0.3 |
| 手机    | 40    |              |            |

### 4. Keepalive - 心跳保活

定期检测订阅者状态，发现断线时触发回调：

- 在线 → 正常响应
- 缓慢 → RTT 超过阈值
- 离线 → 超时无响应

## 数据流向

### 正常观看（SFU 模式）

```
LiveKit SFU
     │
     │ RTP 包
     ▼
Dart 层 (livekit_client)
     │
     │ InjectSFU()
     ▼
SourceSwitcher
     │
     │ WriteRTP()
     ▼
RelayRoom ──→ 所有订阅者
```

### 本地分享（Proxy 模式）

```
本地分享者
     │
     │ InjectLocal()
     ▼
SourceSwitcher ← StartLocalShare()
     │
     │ WriteRTP()
     ▼
RelayRoom ──→ 所有订阅者 (连接不变)
```

## 线程模型

- **主线程**: FFI 调用入口
- **Goroutine 1**: SourceSwitcher 数据处理
- **Goroutine 2**: Keepalive 心跳检测
- **Goroutine 3**: Election 定期评估
- **Goroutine N**: 每个 P2P 连接的 RTCP 读取
